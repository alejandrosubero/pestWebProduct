import{a as s,b as f}from"./chunk-RER757YZ.js";import{_ as d,ea as u,eb as o,f as a,o as n,oc as h}from"./chunk-NT2J2JTX.js";var p=(()=>{class r{constructor(){this._record=o(null),this.record=this._record,this.load()}load(){return a(this,null,function*(){let t=yield s.usageRecords.toArray();this._record.set(t.length?t[0]:null)})}createIfNotExists(t){return a(this,null,function*(){(yield s.usageRecords.count())===0?(yield s.usageRecords.add(t),yield this.load()):console.warn("Ya existe un registro de uso. No se cre\xF3 uno nuevo.")})}update(t){return a(this,null,function*(){t.usageDate||(t.usageDate=new Date().toISOString());let e=this._record();if(!t.id){this.clear(),yield s.usageRecords.add(t),yield this.load();return}yield s.usageRecords.put(t),yield this.load()})}update1(t){return a(this,null,function*(){if(t.usageDate||(t.usageDate=new Date().toISOString()),!t.id){let e=this._record();if(e)t.id=e.id;else{let c=yield s.usageRecords.toArray();if(c.length===0){yield s.usageRecords.add(t),yield this.load();return}else t.id=c[0].id}}yield s.usageRecords.put(t),yield this.load()})}clear(){return a(this,null,function*(){yield s.usageRecords.clear(),this._record.set(null)})}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();var x=(()=>{class r{constructor(){this.usageRecordStoreService=u(p),this.db=u(f),this._products=o([]),this.products=h(()=>this._products()),this.loading=o(!1),this.error=o(null),this.filter=o(""),this.filteredProducts=h(()=>{let t=this.filter().toLowerCase();return this.products().filter(e=>e.name.toLowerCase().includes(t))}),this.loadAll()}loadAll(){return a(this,null,function*(){this.loading.set(!0),this.error.set(null);try{let t=yield this.db.getAllProducts();this._products.set(t)}catch(t){this.error.set("Error al cargar los productos"),console.error(t)}finally{this.loading.set(!1)}})}save(t){return a(this,null,function*(){n(this.db.addProduct(t)).subscribe({next:e=>{let c=e;n(this.loadAll()).subscribe({next:l=>{let i=this.findById(e);i!=null&&i!=null&&(i.package.productId=`${i.id}`,n(this.db.updateProduct(i)).subscribe({next:y=>{this.loadAll()}}))}})},error:e=>console.error("Error:",e)})})}update(t){return a(this,null,function*(){yield this.db.updateProduct(t),yield this.loadAll()})}delete(t){return a(this,null,function*(){yield this.db.deleteProduct(t),yield this.loadAll()})}findById(t){return this._products().find(e=>e.id===t)}setFilter(t){this.filter.set(t)}getPackageSummary(){let t=this.products(),e=0,c=0,l=0;for(let i of t)switch(i.package.status){case"In Use":e++;break;case"In Stock":c++;break;case"Empty":l++;break}return{inUse:e,inStock:c,empty:l}}applyUsage(t){return a(this,null,function*(){let e=this.findById(Number(t.productId));if(!e){this.error.set("Producto no encontrado para aplicar uso");return}e.package.currentQuantity-=t.quantityUsed,e.package.currentQuantity<0&&(e.package.currentQuantity=0),e.package.currentQuantity===0&&(e.package.status="Empty"),e.package.status="In Use",yield this.db.updateProduct(e),yield this.loadAll(),t.productName=e.name,yield this.usageRecordStoreService.update(t)})}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{x as a};
